---
tags:
  - systemd
  - centos
---

**man 1 systemctl**

`systemd` traverses the following paths for the required unit files in order of precedence

1. `/etc/systemd/system` - local unit files and customization go here
2. `/run/systemd/system` - runtime unit files. Do NOT edit
3. `/usr/lib/systemd/system` - unit files generated by RPM packages. Do NOT edit

If the service unit file cannot be found in these dirs, systemd-sysv systems will look in `/etc/init.d` for `SysV Init` (LSB-Compliant) files without the .service suffix. If found, system will execute the **systemd-sysv-generator** command to convert it to a **systemd** unit file, then place it in  `/run/systemd/generator.late/*.service` Using LSB runlevels, it will decide in which target to put the service by creating a symlink.
#### Listing Units And Their States

Service unit files are located by default in `/usr/lib/systemd/system`
When a service is **enabled** it creates a symlink in `/etc/systemd/system/TARGET.wants/`

Unit file states:
* **enabled**: installed and runnable. Starts automatically
* **disabled**: Will not start automatically. No *symlink* in `/etc/systemd/system`
* **static**: the unit file is a dependency of another unit and cannot be manually started
* **masked**: administratively blocked from activating or acting on any of its config directives. Service is symlinked to `/dev/null` and cannot be started
* **bad**: usually a bad unit file
* **indirect**: disabled, has peers in \[Also] clause that may be enabled
* **linked**: unit files available through a symlink

To print all unit types

``` bash
systemctl -t help
```

To list **systemd** active units

``` bash
systemctl -t "UNIT_TYPE"
```

To show active and inactive UNITS

``` bash
systemctl -t "UNIT_TYPE" --all
```

To show enabled services only. States: active, dead, elapsed, exited, inactive   listening, loaded, mounted, not-found, plugged, running, stub, waiting

``` bash
systemctl list-unit-files -t service --state enabled
```

To show if a service is enabled

``` bash
systemctl is-enabled "SERVICE"
```

To show failed services

``` bash
systemctl --failed -t service
```

#### Service Management

To start | stop | restart a service

``` bash
systemctl start | stop | restart "SERVICE"
```

To configure services to start (or not) automatically after restart

``` bash
systemctl enable | disable "SERVICE1" "SERVICEN"
```

Including `--now` will also start | stop the service immediately

Disable and enable a service. Default settings

``` bash
systemctl reenable "SERVICE"
```

To administratively block a service from starting

``` bash
systemctl mask "SERVICE"
```

Undo the above with `unmask`

systemctl can be used on a remote host via SSH

``` bash
systemctl --host "USER"@"HOST" [OPTIONS]
```

##### To remove failed or missing services

* remove the unit files from `/etc/systemd`
* remove the unit files from `/usr/lib/systemd`
* `systemctl daemon-reload`
* `systemctl reset-failed`

Show system state

``` bash
systemctl is-system-running
```

```
[root@prometheus rc0.d]# systemctl is-system-running
maintenance
```
#### Managing Dependencies

Unit types such as sockets, timers, paths are directly related to a service unit,  the first part of the name is the same: **cockpit.socket** works with **cockpit.service**. Dependencies can be defined within the unit, using keywords like:

`Requires`: If this unit loads, units listed here will load also. If one of the other units is deactivated, so will the unit.
`Requisite`: if the unit here is not already loaded, the unit will fail
`Wants`: The unit wants the units listed here to load, but will not fail if one of them fails
`After`: This unit will start after the unit listed here has started 
`Before`: This unit will start before the unit listed here has started

To get a list of dependencies of a service:

``` bash
systemctl list-dependencies "SERVICE"
```

```
[kimchen@rhel81 ~]$ systemctl list-dependencies sshd
sshd.service
● ├─system.slice
● ├─sshd-keygen.target
● │ ├─sshd-keygen@ecdsa.service
● │ ├─sshd-keygen@ed25519.service
● │ └─sshd-keygen@rsa.service
● └─sysinit.target
●   ├─dev-hugepages.mount
●   ├─dev-mqueue.mount
●   ├─dracut-shutdown.service
●   ├─import-state.service
●   ├─iscsi-onboot.service
```

To find out which units are required for a service to start

``` bash
systemctl list-dependencies "SERVICE" --reverse
```

```
[kimchen@rhel81 ~]$ systemctl list-dependencies sshd --reverse
sshd.service
● └─multi-user.target
●   └─graphical.target
```

#### Managing Unit Options

Every unit file can be configured with different options
To get a list of options for a unit:

``` bash
systemctl show "UNIT"
```

When modifying units, you need to make sure changes are reflected in `/etc/systemd/system/UNIT.service.d/override.conf`

edit the drop-in file **override.conf** to add the modifications

To make the service load another service when it loads

```
[Unit]
Requires=service1 service2 etc
```

To make a unit restart after failure

```
[Service]
Restart=on-failure
```

To change unit files configuration

``` bash
systemctl edit "UNIT"
```

To show the current configuration of a unit that starts with:

``` bash
systemctl cat "UNIT"
```

#### Parameterized Units

The @ indicates a parameterized unit file. Multiple unit files can be created for the same service, calling different configuration files. This allows for multiple configurations to be created without writing multiple unit files. OpenVPN works with such units.

The template unit files are in **/usr/lib/systemd/system** in the form of NAME@.service
From this unit file, multiple services can be span off, using different configurations

To create a service

``` bash
systemctl enable "NAME"@"CONFIG_FILE_NAME" # (without the .conf) 
```

Refer to the template file for requirements

```bash
systemctl cat NAME@.service
```


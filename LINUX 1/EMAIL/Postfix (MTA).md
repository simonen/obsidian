---
tags:
  - email
  - dns
  - dovecot
  - POP3
  - postfix
---
`No Start Press - The Book of Postfix`

Postfix is a Mail Transport Agent (MTA), supporting LDAP, SMTP AUTH (SASL), TLS

Packages: 
**postfix**

Ports: 25, 465, 587

#### Files and Directories

Configuration files
- `/etc/postfix/main.cf` - postfix parameters
- `/etc/postfix/master.cf` - conf file the master postfix process uses to find out which services are used for specific tasks. Controls how clients connect to the mail server.

- `/var/spool/postfix`: queue directory
- `/usr/share/doc/postfix-2.10.1/samples`
- `/var/log/maillog`: postfix logs
##### Processes

- `smtpd`: Receives emails from the network.
- `cleanup`: Prepares and sanitizes email for internal handling.
- `qmgr`: Manages the flow of messages and directs them for delivery.
- `smtp`: Sends messages to external destinations.
- `local/virtual`: Delivers emails to local or virtual mailboxes.
- `pickup`: Collects locally submitted emails.
- `bounce`: Handles failed delivery notifications.

#### Postfix Processes (Daemons) and Basic Email Flow

Sequence: 
- `smtpd` -> `cleanup` -> `qmgr` -> `{local, smtp}`

##### SMTP Daemon (`smtpd`)

**Function**: Receives mail from MUA or other mail servers (MTA) over SMTP (port 25 or 587)
* Listens on the SMTP port for incoming connections
* Performs SMTP authentication, spam filtering and connection restrictions
* Hands off the email to the **cleanup** daemon

Sequence: First in line to receive email
##### Cleanup Daemon (cleanup)

Prepares incoming mails for further processing by formatting them into a standard internal structure.

* Adds standard headers, corrects malformed emails and logs them
* Verifies the legitimacy of email addresses, applies necessary transformations like alias expansions
* Passes the message to the `queue manager`

Sequence: After `smtpd`

##### Queue Manager (`qmgr`)

Central hub responsible for managing email flow within Postfix

* Maintains the active queue of mail, waiting for delivery
* Determines the next step for each email: local delivery, forwarding or relaying
* Prioritizes mail delivery (eg. urgent delivering, retrying deferred email)
* Dispatches email to appropriate daemos for final delivery (e.g., local, virtual, smtp)

Sequence: After `cleanup`

##### Local Delivery Daemon (local)

Delivers mails to local users' mailboxes on the same machine

* Responsible for expanding aliases and forwarding settings for local users.
* Uses mailbox formats like mbox or Maildir for delivering the mail.

Sequence: After `qmgr`

##### SMTP Client (smtp)

Sends mail to external domains (remote servers)

* The `smtp` client daemon handles outbound email destined for other MTAs over SMTP
* Connects to remote servers via TCP, applies TLS encryption, performs recipient verification
* Handles retries if delivery fails

Sequence: after `qmgr`

##### Bounce Daemon (bounce)

Generates and handles delivery failure notifications.

* Generates non-delivery reports (NDRs) or "bounce messages" to inform sender of delivery failure.
* Logs and manages information about deferred on permanently failed messages
* Forwards the bounce messages back to the sender or handles it according to rules

Sequence: Triggered by `qmgr` if email cannot be delivered after several attempts

##### Virtual Delivery Agent (virtual)

Delivers mail to virtual mailboxes (domains or users not on the local machine)

* Used for virtual mailboxes when the server hosts email for multiple domains
* The `virtual` daemon delivers these emails based on the virtual domain config

Sequence: After `qmgr`

##### Pickup Daemon (pickup)

Picks up email submitted locally (via command-line, scripts, or internal processes)

* Monitors the maildrop directory for locally submitted messages (e.g., emails generated by the sendmail command)
* Forwards these emails to the cleanup daemon for processing and integration into the email queue

Sequence: The first step for internally generated messages

##### Postscreen Daemon (postscreen)

postscreen - Postfix zombie blocker

man 8 postscreen

##### TLS Daemon (tlsmgr)

Manages TLS session caches and generates key for encrypted connections.

* Ensures secure communication over SMTP by managing encryption protocols, certificates and session caching

Sequence: Used by `smtpd`, `smtp`

##### Anvil Daemon (anvil)

Tracks connection and resource usage.

Sequence: Runs alongside `smtpd`

* Keeps track of connection rates to prevent abuse
* Monitors client behaviour and throttles or blocks clients over suspicious behaviour

```
 postfix/smtpd[17385]: connect from smtp.ohio.cc[192.168.137.9]
Sep 18 15:22:49 smtp postfix/smtpd[17385]: B43F91075DF8: client=smtp.ohio.cc[192.168.137.9]
Sep 18 15:22:55 smtp postfix/cleanup[17388]: B43F91075DF8: message-id=<20240918122249.B43F91075DF8@smtp.ohio.cc>
Sep 18 15:22:55 smtp postfix/qmgr[17380]: B43F91075DF8: from=<gligana@6circles.cc>, size=342, nrcpt=1 (queue active)
Sep 18 15:22:55 smtp postfix/local[17382]: B43F91075DF8: to=<kimchen@ohio.cc>, relay=local, delay=9.7, delays=9.7/0/0/0, dsn=2.0.0, status=sent (delivered to mailbox)
```

##### Essential Postfix Parameters 

* `myorigin`: defines the domain that will be appended to any mail sent from the server where only the local part (username) is specified and the domain part is not. MAIL FROM: 'USERNAME' and RCPT TO: 'USERNAME' will result in email addresses USERNAME@$MYORIGIN. If the full email address is specified 'USER@DOMAIN', $myorigin is ignored. 
	* `$myhostname`: default options. Includes the hostname of the server. 
	* `$mydomain`: uses the domain part of the server only which is the correct way.
* `mydestination`: domains handled by this server. The mail server will only accept mail that is configured for the domains listed here. Mail addressed to a domain not listed in mydestination is rejected. Important for receiving messages. 
* `relayhost`: specifies which central email server to forward messages to. Central mail server with advanced security.
* `local_transport`: specifies what to use for local mail delivery. 
* `inet_protocols`: specifies which protocol to use to offer services. Defaults to IPv6.
* `mynetworks`: space-separated list of networks allowed to relay messages to server
* `inet_interfaces`: interface on which Postfix will offer services. By default is set to localhost. Set to **all** or a specific listening interface.
##### Configuring Postfix

Alternatively to editing the `main.cf` file, the `postconf` command can be used to change parameters.

List the parameters in `/etc/postfix/main.cf`

``` bash
postconf
```

List specific parameters

``` bash
postconf "inet_interfaces" "inet_protocols"
```

```
[root@prometheus ~]# postconf inet_interfaces inet_protocols
inet_interfaces = 10.0.3.89
inet_protocols = all
```

To list non-default parameters only:

``` bash
postconf -n
```

To edit a parameter

``` bash
postconf -e "inet_protocols = all"
```

To list all parameters with their default values

``` bash
postconf -d
```
#### Communication Between Remote Servers

Mail servers should be able to contact each other like any other device.

1. Mail servers must be reachable
2. They must be able to resolve each other properly by having their appropriate DNS records within their zones.

By default, local users can exchange emails on the same postfix server only, as the server is configured to listen on its loopback interface only. For basic connectivity, the mail server must listen on an open interface.

Minimal postfix setup

`/etc/postfix/main.cf`
```
mydomain = 'DOMAIN'
myorigin = $mydomain
inet_interfaces = localhost | IP address | loopback-only | all
inet_protocols = [ipv4 | ipv6 | all] 
mydestination = \$myhostname, localhost.$mydomain, localhost, $mydomain
my_networks = "NET1" "NET2" - to include client networks if not on the same net as server
```

#### Testing connectivity to an SNMP Server

To test a remote SMTP connection on port 25 with a server

``` bash
telnet 'REMOTE SERVER' 25
```

```
root@ss1:~# telnet 10.0.3.89 25
Trying 10.0.3.89...
Connected to 10.0.3.89.
Escape character is '^]'.
220 prometheus.olympus.local ESMTP Postfix
...
DATA
"Message"
.
```

Simple SMTP messages can be sent to a user's inbox over telnet. Commands:

* **EHLO** client: Extended HELO message sent to a mail server to introduce the client server
* **MAIL FROM**: *SENDER*
* **RCPT TO**: *RECEIVER*
* **DATA**: Press ENTER and type the message body. Terminate with . on the last line.
	* email headers like Subject: or Full name:, also can be included
* **QUIT**

Multiple commands can be issued at once with the help of `PIPELINING` if the SMTP server supports it. Prepare the commands in a text file and feed it to the telnet or openssl s_client 

```bash
openssl s_client -starttls smtp -connect smtp.6circles.cc:25 < smtp-commands.txt
```

#### Basic Mail Troubleshooting

Postfix and Dovecot log files: 
- `/var/log/maillog`

To check the mail queue

``` bash
mailq
postqueue -p
```

To force send the messages in the queue:

``` bash
postqueue -f
```

#### SMTP Authentication

[POSTFIX SASL AUTHENTICATION OFFICIAL DOC](https://www.postfix.org/SASL_README.html)

Postfix does not provide authentication natively, but can be configured together with other software packages: `cyrus`, `dovecot` to use them as authentication servers

Authentication for e-mail servers is provided by a mechanism called SMTP AUTH. To confirm user's credentials, AUTH uses the SASL authentication framework. It is much like a PAM.

> Enabling SMTP authentication does NOT mean it is enforced! Check out [[gitea/LINUX 1/EMAIL/Email Security]] note

List  the available SASL server plug-in types:

``` bash
postconf -a
# cyrus 
# dovecot
```

In this case SASL can be configured with cyrus or dovecot. The SASL plug-in type is selected with the `smtpd_sasl_type` configuration parameter

`/etc/postfix/main.cf`
```
smtpd_sasl_auth_enable = yes 
smtpd_sasl_type = dovecot
# local auth socket !
smtpd_sasl_path = private/auth
# if dovecot is remote
smtpd_sasl_path = inet:DOVECOT_SERVER

smtpd_sasl_security_options = noanonymous 
smtpd_sasl_local_domain = 
broken_sasl_auth_clients = yes
# use authentication only if tls is enabled
smtpd_tls_auth_only = yes 
```


`/etc/dovecot/conf.d/10-auth.conf`
```
auth_mechanisms = plain login
```

`/etc/dovecot/conf.d/10-master.conf`
```
service auth {

   # Postfix smtp-auth
     unix_listener /var/spool/postfix/private/auth {
     mode = 0666
     user = postfix
     group = postfix
   }
 }
```

`unix-listener`: the socket that provides the connection between **postfix** and **dovecot**. The user and group directives set the ownership of the socket. Defaults to root if not specified.

``` bash
ls -l /var/spool/postfix/private/auth
```

```
srw-rw-rw-. 1 postfix postfix 0 Sep  9 15:07 /var/spool/postfix/private/auth
```
Testing SASL-enabled SMTP connections requiring starttls

``` bash
openssl s_client -connect 'SMTP_SERVER':25 -starttls smtp
```

Introduce yourself

``` bash
EHLO 'YOU'
```

```
220 prometheus.olympus.local ESMTP Postfix
EHLO kimchen
250-prometheus.olympus.local
250-PIPELINING
250-SIZE 10240000
250-VRFY
250-ETRN
250-AUTH PLAIN LOGIN
250-AUTH=PLAIN LOGIN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
```

`250-AUTH PLAIN LOGIN` means SASL is enabled
`AUTH` will appear after `STARTTLS` 

Encode the 'user pass' pair in base64. \\0 = ASCII NULL character

``` python
import base64  
  
username = "user"  
password = "pass"  
  
# Construct the string in the required format  
auth_string = f'\0{username}\0{password}'
# NULLuserNULLpassword
  
# Encode the string in Base64  
base64_auth_string = base64.b64encode(auth_string.encode()).decode()  
  
print(base64_auth_string)  
```

Authenticate

``` bash
AUTH PLAIN 'base64_auth_string'
# 235 2.7.0 Authentication successful
```

Authenticate with AUTH LOGIN. Requires base64 encoded username and password on separate lines

``` bash
AUTH LOGIN
# 334 VXNlcm5hbWU6
'base64 username'
# 334 UGFzc3dvcmQ6
'base64 password'
# 235 2.7.0 Authentication successful
```

Now postfix permits but does not enforce authentication. 

```
postfix/smtpd[2760]: 663833074C34: client=unknown[10.0.3.80], sasl_method=PLAIN, sasl_username=fikretka
```

The following shows an unsuccessful authentication attempt. 

```
 mail postfix/smtpd[4891]: disconnect from smtp.6circles.cc[192.168.137.2] ehlo=2 starttls=1 auth=0/1 quit=1 commands=4/5
```

- `ehlo=2`: The client issued the **EHLO** command twice
- ``starttls=1``: The client issued the **STARTTLS** command once and successfully upgraded the connection to use TLS.
- ``auth=0/1``: The client attempted to authenticate but did **not successfully complete authentication**. The format `auth=0/1` means zero successful attempts out of one authentication
#### Secure SMTP with Encryption

https://www.postfix.org/TLS_README.html

S/MIME - content-based encryption solution. PGP, GnuPG

[[LINUX/PKI/OpenSSL#Generate a Self-Signed Certificate]] 

`/etc/postfix/main.cf`
```
smtpd_use_tls = yes
smtp_use_tls = yes
smtpd_tls_cert_file = /etc/postfix/ssl-cert-snakeoil.pem
smtpd_tls_key_file = /etc/postfix/ssl-cert-snakeoil.key

smtpd_tls_security_level = may
smtpd_tls_loglevel = 1
smtp_tls_loglevel = 1
smtpd_tls_received_header = yes
smtpd_tls_protocols = TLSv1.2 TLSv1.3
```

Check the server's supported TLS protocol versions with nmap and adjust the `smtpd_tls_procols` directive accordingly.
#### Test SASL with TLS

```
Sep  8 18:44:25 smtp postfix/smtpd[2691]: Anonymous TLS connection established from unknown[192.168.137.10]: TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits)
```

```
Return-Path: <bibka@6circles.cc>
X-Original-To: root@6circles.cc
Delivered-To: root@6circles.cc
Received: from bik (as EHLO) (smtp.6circles.cc [192.168.137.2])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
```

``` bash
openssl s_client -connect 'MAIL.SERVER':25 -starttls smtp
```

www.checktls.com : service to test if your web server supports TLS.
#### Aliases

Postfix uses a configuration option called *alias_maps* in main.cf to specify a file
`/etc/aliases`

Common use is to have system users redirect messages to root and then root messages to another user.
Messages addressed to one user are redirected to another using aliases. 
user1: user2 - Mail to user1 is now redirected to user2.
user1: user2,user3

To commit changes made to the aliases file

``` bash
newaliases
```

To make a query to the alias database. This will return the value of the USER key.

``` bash
postalias -c /etc/postfix/ -q 'USER' hash:/etc/aliases
```

```
[root@smtp ~]# postalias -c /etc/postfix/ -q sales hash:/etc/aliases
postmaster
```
#### Mailbox Format

`mbox` (deprecated) : Postfix uses the mbox format to store emails within a single file. It has the potential to get corrupted.

`Maildir` - stores emails in different files in a directory. This allows multiple processes to interact with the mailbox without risking conflicts and corruption.

`/etc/postfix/main.cf`
```
home_mailbox = Maildir/
```

This creates a Maildir/ dir in the user's home dir with the following structure

```
[gligana@smtp ~]$ tree
.
├── mail
└── Maildir
    ├── cur
    ├── new
    │   └── 1725788043.Vfd00I30aed2fM847822.smtp.6circless.cc
    └── tmp
```

> [!NOTE]
> It is important that the Maildir/ dir is owned and accessible only by its respective user

Custom folders like *Sent* for example are created with a . prefix.

#### LMTP (Local Mail Transport Protocol)

Dovecot side. Enable the stack

`/etc/dovecot/dovecot.conf`
```
protocols = lmtp imap pop3 submission
```

Configure the Socket. Can be bound to INET and Unix sockets. 

`/etc/dovecot/conf.d/10-master.conf`
```
service lmtp {
  unix_listener /var/spool/postfix/private/dovecot-lmtp {
  mode = 0600
  user = postfix
  group = postfix
  }
}
```

LMTP uses the LHLO verb. To test the LMTP socket

``` bash
nc -U /var/spool/postfix/private/dovecot-lmtp
```

```
220 smtp.ohio.cc Dovecot ready.
LHLO localhost@domain.com
250-smtp.ohio.cc
250-8BITMIME
...
```

Postfix side

`etc/postfix/master.cf`
```
lmtp      unix  -       -       n       -       -       lmtp
```

Configure Postfix to use the *lmtp* socket for final delivery

`/etc/postfix/main.cf`
```
mailbox_transport = lmtp:unix:/var/spool/postfix/private/dovecot-lmtp
```
or
```
virtual_transport = lmtp:unix:private/dovecot-lmtp
```

[[gitea/LINUX 1/EMAIL/Mail Delivery Agents (MDA)#Mail Location]] - how to set up mail location

If working properly (mbox version, deprecated): 

```
smtp dovecot lmtp(kimchen)<19.kd/1w>: msgid=<20..5F1B@smtp.ohio.cc>: saved mail to INBOX
```
#### Smarthosting

A **smarthost** is a relay server that receives and forwards email. Two types:
* authenticated
* unauthenticated

`/etc/postfix/main.cf`
```
relayhost = 'SMARTHOST_HOSTNAME'
```

This tells postfix to send all outgoing e-mail to the *smarthost* (relayhost), assuming that the *smarthost* is configured to accept e-mail from you.

##### Smarthost authentication

The *relayhost* acts as a client, therefore the configuration options are as follows:

`/etc/postfix/main.cf`
```
smtp_sasl_password_maps = hash:/etc/postfix/smtp_sasl_passwd 
smtp_sasl_auth_enable = yes 
smtp_sasl_mechanism_filter = plain, login 
smtp_sasl_security_options = noanonymous
```


`smtp_sasl_password_maps` : specifies a database file containing a list of *smarthosts* and their required credentials

`/etc/postfix/smtp_sasl_passwd`
```
'SMARTHOST'    username:password
```

This must be readable only by the root.

Create the database

``` bash
postmap /etc/postfix/smtp_sasl_passwd
```

#### Virtual Domains

[Virtual Domains](https://www.postfix.org/VIRTUAL_README.html)

The smtp server can be configured to be the final destination of multiple domains by using the `mydestination` configuration. This means that mail destined for user@example.com user@example.id and user@example.net will end up in the same Linux user's mailbox. This can be fixed by mapping `virtual domains` to users

- `mydestination = mail.example.com example.net example.id example.com`
- `canonical domains`: domains configured to be the final destination that include the hostname and often the domain of the postfix that runs on.
- `hosted domains`: the final destination of any other domains that are not directly associated with the name of the machine that Postfix runs on. Hosted domains are implemented with:
	* `virtual_alias_domain` class and/or
	* `virtual_mailbox_domain` address class

If postfix gets email for the example.net, .id, .com, it should use an indexed file `/etc/postfix/virtual`, which contains the virtual domain:user mappings.

`/etc/postfix/main.cf`
```
virtual_alias_domains = example.net example.id example.com 
virtual_alias_maps = hash:/etc/postfix/virtual
```

`etc/postfix/virtual`
```
gligana@6circles.cc gligana
kimchen@6circles.cc kimchen
kimchen@6circles.id taylor
gligana@6circles.id chuguna
```

Create the indexed file

``` bash
postmap /etc/postfix/virtual
systemctl restart postfix
```

This means that mail sent to gligana@6circles.cc will go to user gligana's mailbox on the postfix server. Mail sent to gligana@6circles.id will go to user chuguna's mailbox on the postfix server. The address can be a local Linux user or a remote address, such as `user@6circles.net`

Here is how mapping works: 

```
smtp postfix/qmgr[2448]: C49CE303D40D: from=<kimchen@6circles.cc>
smtp postfix/local[2461]: C49CE303D40D: to=<gligana@6circles.cc>
smtp postfix/local[2460]: C49CE303D40D: to=<chuguna@6circles.cc>, orig_to=<gligana@6circles.id>,
```
#### Virtual Mailbox Domains and non-Unix users

[Virtual users](https://doc.dovecot.org/2.3/configuration_manual/virtual_users/)

With the Postfix [virtual(8)](https://www.postfix.org/virtual.8.html) mailbox delivery agent, every recipient address can have its own virtual mailbox. Unlike virtual alias domains, [virtual mailbox domains](https://www.postfix.org/ADDRESS_CLASS_README.html#virtual_mailbox_class) do not need the clumsy translation from each recipient addresses into a different address, and owners of a virtual mailbox address do not need to have a UNIX system account.

Virtual mailboxes structure. Should be owned by a regular unix user with UID/GID specified in main.cf. Create only the domain dir, vmail handles the rest of the dirs.

```
VIRTUAL_MAILBOX_BASE/DOMAIN/USER/Maildir{new,cur,tmp}
/var/mail/vhosts/DOMAIN_1/user1/Maildir
/var/mail/vhosts/DOMAIN_1/user2/Maildir
/var/mail/vhosts/DOMAIN_2/user1/Maildir
/var/mail/vhosts/DOMAIN_N/user1/Maildir
```

Create a `vmail` system user that will handle the virtual mailboxes on behalf of the email users.

```
useradd -u 5000 -s /sbin/nologin vmail
```

``` bash
chown -R vmail:vmail /var/mail/vhosts
chmod -R 700 /var/mail/vhosts
```

> Virtual mailbox domains and virtual alias domains should not be used at the same time!

#####  Postfix side

> The virtual mailbox domain path is where Postfix delivers mail.

Make sure to use the `Maildir/` mailbox format.

`/etc/postfix/main.cf`
```
home_mailbox = Maildir/
```


Configure Postfix to deliver the mail to the virtual boxes

`/etc/postfix/main.cf`
```
virtual_mailbox_domains = DOMAIN1 DOMAIN2
virtual_mailbox_base = /var/mail/vhosts
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_minimum_uid = 100
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000
```

Map the email address to the virtual mailbox. Do not forget tne '/' otherwise postfix will look for a Maildir file. This is the place postfix delivers mail to

`/etc/postfix/vmailbox`
```
USER@DOMAIN      DOMAIN/USER/Maildir/
```

Create the indexed file

``` bash
postmap /etc/postfix/vmailbox
postfix reload
```

##### Dovecot side

**Using a passwd-file for authentication store**

[[gitea/LINUX 1/EMAIL/Mail Delivery Agents (MDA)#Dovecot Administration with doveadm]]

As virtual users, rather than Unix users, are gonna be used, disable PAM authentication. Comment out the passdb and userdb sections of the /etc/dovecot/conf.d/auth-system.conf.ext file

> The mail location on the MDA side is where Dovecot retrieves mail from

`/etc/dovecot/conf.d/10-mail.conf`
```
mail_location = maildir:/var/mail/vhosts/%d/%n/Maildir
```

- `%d`: the domain part of the email address
- `%n`: the user part of the email address

> For the % variables to work, use the `user@domain` format for user authentications

Create the per-domain user and pass databases (stores) [passwd-file](https://doc.dovecot.org/2.3/configuration_manual/authentication/passwd_file/#authentication-passwd-file)

Selinux context of the passwd file

`/var/mail/vhosts/DOMAIN/passwd`
```
imap_user:{SCHEME}user_password:5000:5000::/home/user::userdb_mail=maildir:/var/mail/vhosts/DOMAIN/Maildir allow_nets=192.168.0.0/24
smtp_user2:{SCHEME}user_password2:5001:5001::/home/smtp_user2
```


The password scheme can be set to {plain}plain_password or hashed. For example {MD5}hashed_pa

Configure Dovecot to use the new passwd db files for each domain dynamically. Due to SELinux blocking access to the passwd file, put them in /etc/dovecot/DOMAIN.passwd as a workaround

`/etc/dovecot/conf.d/auth-passwd.conf.ext`
```
passdb {
  driver = passwd-file
  args = /var/mail/vhosts/%d/passwd
  args = /etc/dovecot/%domain.passwd
}
userdb {
  driver = passwd-file
  args = /var/mail/vhosts/%d/passwd
  args = /etc/dovecot/%domain.passwd
  }
```

Additional userdb args can be included

```
# what format is expected in the passwd file. In this case: just the username part
args = username_format=%n 
# if not specified in the passwd file
default_fields = uid=vmail gid=vmail home=/home/vmail/%u
```

Test the SMTP authentication with the virtual user

```
telnet 'SMTP_SERVER' 25
EHLO hostname
auth login
base64 username
base64 password
```

Test the IMAP authentication with the virtual user

```
telnet 'IMAP_SERVER' 143
tag login USER PASS
```

#### Troubleshooting Postfix

https://www.postfix.org/DEBUG_README.html

`debug_peer_list = troubled.domain.co`

SELinux is blocking access to /var/mail link. SELinux issue. Context relabeling does not help.

```
Error: passwd-file(gligana@ohio.org,192.168.137.1,<NsBF4bEi5PDAqIkB>): stat(/var/mail/vhosts/ohio.org/passwd) failed: Permission denied (euid=97(dovecot) egid=97(dovecot) missing +w perm: /var/mail/vhosts/ohio.org/passwd stat(/var/mail/vhosts/ohio.org/passwd) failed: Permission denied, dir owned by 0:0 mode=0755)
```

Successful authentication

```
passwd-file(kibuna,192.168.137.1,<gEfSEKYiwufAqIkB>): Performing passdb lookup
Sep 21 22:21:42 mail dovecot[13371]: auth: Debug: passwd-file(kibuna,192.168.137.1,<gEfSEKYiwufAqIkB>): lookup: user=kibuna file=/etc/dovecot/passwd
```

```
mail postfix/smtpd[15479]: connect from _gateway[192.168.137.1]
mail postfix/smtpd[15479]: Anonymous TLS connection established from _gateway[192.168.137.1]: TLSv1.3 with cipher TLS_AES_128_GCM_SHA256 (128/128 bits) key-exchange X25519 server-signature RSA-PSS (2048 bits) server-digest SHA256
mail dovecot[15457]: auth: Debug: passwd-file(postuser@ohio.net,192.168.137.1): Performing passdb lookup
mail dovecot[15457]: auth: Debug: passwd-file(postuser@ohio.net,192.168.137.1): lookup: user=postuser file=/var/mail/vhosts/ohio.net/passwd
mail dovecot[15457]: auth: Debug: passwd-file(postuser@ohio.net,192.168.137.1): Finished passdb lookup
mail dovecot[15457]: auth: Debug: auth(postuser@ohio.net,192.168.137.1): Auth request finished
mail dovecot[15457]: auth: Debug: client passdb out: OK#0112#011user=postuser@ohio.net
mail postfix/smtpd[15479]: 573E93166F95: client=_gateway[192.168.137.1], sasl_method=PLAIN, sasl_username=postuser@ohio.net
mail postfix/cleanup[15484]: 573E93166F95: message-id=<94d57949-8014-4410-8db5-86d8b38788da@ohio.net>
mail postfix/qmgr[15446]: 573E93166F95: from=<kibuna@ohio.net>, size=712, nrcpt=1 (queue active)
mail postfix/virtual[15485]: 573E93166F95: to=<kibuna@ohio.net>, relay=virtual, delay=0.02, dsn=2.0.0, status=sent (delivered to maildir)
mail postfix/qmgr[15446]: 573E93166F95: removed
mail dovecot[15457]: imap(kibuna@ohio.net)<15487><2f5A3KYiNtnAqIkB>: Disconnected: Logged out in=826 out=705 deleted=0 expunged=0 trashed=0 hdr_count=0 hdr_bytes=0 body_count=0 body_bytes=0
mail postfix/smtpd[15479]: disconnect from _gateway[192.168.137.1] ehlo=2 starttls=1 auth=1 mail=1 rcpt=1 data=1 quit=1 commands=8
```

`auth_debug_passwords = yes `: shows the attempted plain password in logging. Potential sec risk. Should be used for debugging purposes only

```
mail dovecot[3064]: auth: passwd-file(postuser@ohio.net,192.168.137.10): Password mismatch
Sep 22 13:02:19 mail dovecot[3064]: auth: Debug: passwd-file(postuser@ohio.net,192.168.137.10): MD5(123123) != '$1$ZPqhpcAp$AzJ9LUtQo4ySR/H.rVW43'
```

#### SQL and Virtual Domains and Users

**Packages:**
`postfix-mysql`
`dovecot-mysql`

The data-base driven virtual mailbox domains work similarly to the standard indexed (hash) lookup tables, which in this case act as SQL query constructors that retrieve info from the SQL db.

##### SQL Schema

Database: mail
Tables: virtual_users

``` mysql
CREATE DATABASE mails;
USE mails;
CREATE TABLE `virtual_users` (
`id` int(11) unsigned NOT NULL auto_increment,
`username` varchar(255) NOT NULL,
`domain` varchar(255) NOT NULL,
`password` varchar(255) NOT NULL,
`auth` tinyint(1) default '1',
`active` tinyint(1) default '1',
`userid` varchar(255) NOT NULL,
`uid` smallint(5) default '5000',
`gid` smallint(5) default '5000', 
`home` varchar(255),
PRIMARY KEY (`id`),
UNIQUE KEY `id` (`id`),
INDEX `recipient` (email)
) COMMENT='SMTP AUTH and virtual users';
```

Insert users

``` sql
INSERT INTO virtual_users (username, domain, password, auth, active, email, uid, gid, home)
VALUES ('USERNAME', 'DOMAIN', 'PLAIN-MD5 HASH', 1, 1, 'USERNAME@DOMAIN', VUID, VGID, '/DOMAIN/USERNAME/Maildir/');
```

| id  | username | domain   | password  | userid           | uid  | gid  | home                       |
| --- | -------- | -------- | --------- | ---------------- | ---- | ---- | -------------------------- |
| 1   | gligana  | ohio.net | 2411asd.. | gligana@ohio.net | 5000 | 5000 | /ohio.net/gligana/Maildir/ |

Create a mail db user that has read-only access to the db.

```
CREATE USER postfix@% IDENTIFIED BY 'your_password';
GRANT SELECT ON mail.virtual_users TO 'postfix'@'MAIL_SERVER';
```

##### Postfix Config

Check Postfix for SQL map support

``` bash
$ postconf -m
static
mysql
hash
```

Install the postfix-mysql package

Create the SQL query generators to serve as lookup tables. Postfix requires 3 basic queries:

 * `recipient`: to return the recipient's mail location
 * `uid`: to return the UID of the mail directory owner
 * `gid`: to return the GID of the mail directory owner

The `vid` and `gid` are taken dynamically from the database because every domain will have its unique owner, instead of a single user serving all domains and mail directories.

`/etc/postfix/main.cf`
``` bash
virtual_mailbox_domains = 'VDOMAIN1' 'VDOMAIN2'
#virtual_mailbox_domains = mysql:/etc/postfix/sql/virtual_mailbox_domains.cf
virtual_mailbox_base = /var/mail/vhosts
virtual_minimum_uid = 100
virtual_uid_maps = mysql:/etc/postfix/sql/virtual_uid_maps.cf
virtual_gid_maps = mysql:/etc/postfix/sql/virtual_gid_maps.cf
virtual_mailbox_maps = mysql:/etc/postfix/sql/virtual_mailbox_recipients.cf
```

**Recipients Query Constructor**

`/etc/postfix/sql/virtual_mailbox_recipients.cf`
``` bash
user = 'DB USER'
password = 'DB USER PASS' 
dbname = mail 
table = virtual_users
select_field = home
where_field = userid
additional_conditions = and active = '1'
hosts = 'SQL SERVER'
```

This will translate into a SQL query. This tells Postfix where to send the email

``` mysql
SELECT 'select_field' FROM 'table' WHERE 'where_field' = 'recipient' AND active = '1'
```

```
MariaDB [mail]> SELECT home FROM virtual_users WHERE userid = 'gligana@ohio.net';
+----------------------------+
| home                       |
+----------------------------+
| /ohio.net/gligana/Maildir/ |
+----------------------------+
```

To test the query from the Postfix side

``` bash
postmap -q "recipient" mysql:/etc/postfix/sql/virtual_mailbox_recipients.cf 'home'
```

If query is successful, it should return the value of the home field

```
/ohio.net/gligana/Maildir/
```

Virtual UID/GID Maps Query Constructors

`/etc/postfix/sql/virtual_uid_maps.cf`
``` bash
user = 'DB USER'
password = 'DB USER PASS' 
dbname = mail 
table = virtual_users
select_field = uid
where_field = userid
hosts = 'SQL SERVER'
```

`/etc/postfix/sql/virtual_gid_maps.cf`
``` bash
user = 'DB USER'
password = 'DB USER PASS' 
dbname = mail 
table = virtual_users
select_field = gid
where_field = userid
hosts = 'SQL SERVER'
```

##### Dovecot Config

Install the dovecot-mysql package

Dovecot handles authentication. 

Define the SQL conf file

`/etc/dovecot/conf.d/auth-sql.conf.ext`
```
passdb {
  driver = sql
  # Path for SQL configuration file
  args = /etc/dovecot/dovecot-sql.conf.ext
}

userdb {
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}
```

`/etc/dovecot/dovecot-sql.conf.ext`
```
driver = mysql
connect = host=192.168.137.12 dbname=mail user=kimchen password=123123 port=3306
password_query = SELECT username AS username, domain, password FROM virtual_users WHERE username = '%n' AND domain = '%d'
user_query = SELECT home, uid, gid FROM virtual_users WHERE username = '%n' AND domain = '%d'
```

Finally, configure dovecot to use SQL for authentication. Comment out the other methods.

`/etc/dovecot/conf.d/10-auth.conf`
```
!include auth-sql.conf.ext
```

Test authentication

``` bash
doveadm -v auth test 'userid'
Password:
passdb: gligana@ohio.net auth succeeded
extra fields:
  user=gligana@ohio.net
```

Test SMTP authentication

```
openssl s_client -connect -starttls smtp 'MAIL_SERVER':'PORT'
```